# AgRowStitch
An image stitching pipeline for agricultural rows.

## Installation

To install:

```
pip install .
```

Additionally, this library depends on LightGlue which must be installed from github.

```
git clone https://github.com/cvg/LightGlue.git && cd LightGlue
python -m pip install -e .
```

## Running
AgRowStitch is a singly executable python file to make it easy to use. Run "AgRowStitch.py" from the command line with the path to your "config.yaml" as the only argument. An optional second argument can be passed to specify the number of CPUs to use if the pipeline should be run in parallel or on a computer cluster. 

### Congfiguring Basic Settings
Update the "config.yaml" to customize parameters and then pass the path of the config file when running the script. At a minimum, the path to your image directory must be updated to run the pipeline. The images in each "image_directory" of a "parent_directory" should have minimal distortion and filenames that, when sorted, order the images in stitching order. Sequential images must overlap to create a mosaic. The final mosaics will be saved in a folder called "final_mosaics" that is at the level above the parent or image directory.

In addition to specifying the path to the images, users must specify the "sittching_direction" of the images ("LEFT", "RIGHT", "UP", "DOWN"), which indicates the direction of camera movement relative to the image. To allow the pipeline to skip images with high overlap, the "forward_limit" can be set to an integer over one. The "forward_limit" corresponds to how many images the pipeline will attempt to skip when making matches and should increase for datasets with high overlap between consecutive images. The "max_reprojection_error" is the pixel-scale reprojection error that is acceptable when matching images. As the resolution of the images increases, so should "max_reprojection_error". Higher "max_reprojection_error" paired with a higher "forward_limit" will generally produce a mosaic with fewer images and improve the run time, but at the expense of the mosaic quality. On the other hand, if "max_reprojection_error" and "forward_limit" are too low, more images will be used, potentially increasing the number of stitching artifacts in areas of image overlap.

AgRowStitch can be configured to use a CUDA-enabled GPU during feature extraction and matching by setting "device" to "cuda". The GPU is only used during the feature extraction and matching steps. If the pipeline is run without a GPU, it can be process multiple image directories found in "parent_directory" in parallel by setting "device" to "multiprocessing". The number of CPUs to use when running in "multiprocessing" mode shoudl be passed as a second argument when running AgRowStitch from the command line. Otherwise, the "device" should be set to "cpu" to process image directories in series without using the GPU.

### Save Settings
The "final_resolution" can be set relative to the native resolution of the input images. A "final_resolution" of 1 will stitch all of the images while maintaining their original resolution, while a lower number will downscale the images before stitching them, which may improve run time at the expense of final image resolution. The "seam_resolution" can be set to downscale the original resolution of the images when finding seams. Since seams can be found at lower resolution without sacrificing quality, it is recommended to keep the "seam_resolution" at relatively low values around 0.1-0.2. To save the final mosaic as is, set "save_full_resolution" to True, to additionally save a low resolution version of the image for easier loading and sharing, set "save_low_resolution" to True and specify the downscale factor in "low_resolution". AgRowStitch splits the stitching process into batches by first stitching images into batches and saving them in an output folder, then when all batches are finished, it reads the batches and stitches them into the final mosaic. This helps free up memory instead of holding each batch mosaic in memory until they are all finished. To save these intermediate batch mosaics, set "save_output" to True, otherwise these files will be deleted after the final mosaic is completed. This may be helpful when troubleshooting.

The final mosaic may have a variable final height (corresponding to the short dimension of the agricultural row) depending on the stability of the camera and the quality of the images. However, the length of the mosaic should correspond to the length of the row being imaged. To create a consistent pixel:distance relationship, you can specify the "final_size" of the mosaic and set "save_resized_resolution" to True. The "final_size" should be input as "[width, height]", where the "width" and/or "height" are set as integers. The "width" corresponds to the direction of the camera movement and should generally be the value that is set, while setting "height" to zero. This scales the final mosaic to create a known pixel:row length ratio, but allows the "height" of the mosaic to remain free. Specifying "height" and leaving "width" as zero can be used when the camera is very stable and the field of view always matches the height of the row, but the length of different rows is variable. If both the "width" and "height" are set to non-zero integers the mosaic will be scaled to match both dimensions, though this may cause distortion because the "width":"height" of the row may not be preserved in the stitching process, particularly if the camera is unstable. If many rows are imaged of a set width and height and, for consistency, the final mosaics should have the same "width" and "height", we recommend setting the "width" to a constant value and then using the "crop" parameter to set the desired "height". If the final mosaic, once scaled to the "width" in "final_size", has a larger "height" than the "crop" parameter, it will be cropped on the boundaries to get to the desired "height", and if it has a smaller "height" than the "crop" parameter, it will be padded with black pixels at the boundaries to reach the desired "height".

### Advanced Settings
To change other aspects of the stitching process, users can adjust the advanced settings. To get more informative information in the console and logs, change "verbose" to True. The images are stitched in batches according to the "batch_size". Larger "batch_sizes" will result in fewer total batches and thus fewer opportunities for errors when batches are stitched together. However, large batches can also increase computational time when the "camera" is set to "spherical", since there is a bundle adjustment step that becomes more and more difficult with each image. If the "camera" is set to "partial_affine", there is no bundle adjustment and larger batches should not affect performance. Stitching quality is often better with the "spherical" setting, which can sometimes help account for camera instability and parallax.

The "keypoint_prop" sets the proportion of the image from the stitching edge that should be searched for keypoints. For instance, with a "keypoint_prop" of 0.2, AgRowStitch will first attempt to stitch the images using only keypoints found in the last fifth of one image and the first fifth of the next image. This helps eliminate false matches and takes advantage of the fact that images should be stitched according to the camera movement. If pre-filtering keypoints by their location relative to the stitching edge becomes too restrictive for a pair of images, AgRowStitch will automatically try with a more relaxed "keypoint_prop" until the full images are used (i.e. "keypoint_prop" = 1). The "xy_ratio" and "scale_constraint" are used to reject potential homography matrices. We assume that the camera is moving along a row of crops, with the camera centered on the row and kept at a relatively constant height. The homography matrix will estimate the translation along the row (x) and normal to the row (y) across images, while the scale of the image corresponds to changes in the height of the camera (z). To avoid false matches, the user can set rejection criteria for the ratio of x versus y translation in "xy_ratio" (x_translation/y_translation > xy_ratio)and the absolute change in scale relative to 1 in "scale_constraint" (|scale - 1| < scale_constraint). 

Each homography matrix is estimated by identifying inlier points using a RANSAC threshold. Users can control this process by setting the minimum number of inliers that must be found to accept a homgoraphy ("min_inliers") and the RANSAC threshold used to identify those inliers ("max_RANSAC_thresh"). The RANSAC threshold corresponds to a pixel error in the reprojection error of a point for it to be considered an inliers, so a smaller thresholds create stricter filters. AgRowStitch will try to find at least "min_inlier" inlier points using different thresholds, but will not surpass "max_RANSAC_threshold". If insufficient inliers are found, even with the highest threshold, the image pair is rejected, otherwise the smallest threshold that creates sufficient inliers is used. If more inliers are found above "min_inliers", the reprojection error of the homography is minimized by removing points with the highest error until it no longer lowers the reprojection error or there are insufficient inliers. This final reprojection error must than be below "max_reprojection_error", set in the Basic Settings, for the image pair to be accepted.

To minimize drift in the mosaic, AgRowStitch straightens each batch mosaic and the final mosaic. This is one of the reasons that AgRowStitch was designed to work only on single, straight rows of crops. The other reason is that it allows us to assume that images only nbeed to be stitched in one direction (the direction of camera movement). The straightening process can be turned off for the final mosaic by setting "final_straighten" to False. This is only recommended if the final straightening process results in too much of the row height being cropped out. Other aspects of the straightening process can be set with "points_per_image" and "straightening_threshold" which set the number of points that are used for each of the images used in a mosaic to straighten it and the threshold in the change in the pixel-scale slope across those points that triggers a straightening event. If the images are not sufficiently straight, try decreasing the "straightening_threshold" and/or increasing "points_per_image".

### GPS Settings
To help users georeference their mosaics, AgRowStitch saves a .csv file that lists each image and the pixel position of the center of that image in the final mosaic. If the images are paired with GPS data, "gps.csv" should be in each image directory with columns "image", "latitude", and "longitude" and "GPS" should be set to True in the "config.yaml". In this case, the pixel positions of each image will populate "gps.csv". Users can also have each mosaic reorient before saving by setting "change_orientation" to "90CW", "90CCW", or "180". AgRowStitch uses "stitching_direction" to reorient the images so that they are stitched to the left in the image coordinate system. Since users may prefer the mosaic to be in a different orientation, the mosaic can be rotated from this right to left orientation (where the first image will be on the far right of the mosaic) to a vertical or reversed orientation. Users can also set "change_orientation" to "COMPASS" if "GPS" is also set to True. In this case, the GPS coordinates in "gps.csv" will be used to estimate which cardinal direction the camera is moving and then orient the mosaic such that the top edge of the mosaic points to the North.
 

## Concept
AgRowStitch is a user-friendly and open source pipeline designed for converting images of row crops into image mosaics. The pipeline was created to reliably stitch images taken close to  crops without additional requirements, such as GPS data or expensive camera rigs. Since the stitched images may be used to segment structures and extract other phenotypic information, it is important that plant structures not be duplicated or ommitted from the stitched image. However, stitched plant images are particular susceptible to poor stitching because: 1) feature extraction using traditional methods (e.g. ORB, SIFT) may lead to poor matching when the image is filled with similar objects (e.g. leaves); 2) plants are non-planar, making it difficult to find the correct homography between images; and 3) plants are not rigid, so there may be simultaneous camera movement and object movement.

To reduce the occurence of poor stitches, we primarily aim to reduce the number of images used in the final stitched image and filter features. We assume that images are ordered and that the overlap between images decreases for more distant image pairs, so we iteratively search for the most distant image that can be reliably matched with the focal image. To determine whether images are sufficiently matched, we use LightGlue to extract and match features and then require that the images have a high number of matched keypoints using RANSAC with a maximum threshold and that those matched keypoints have a low reprojection error. To eliminate potential keypoint mismatches, we exclude keypoints based on their position on the source and destination images such that source keypoints and destination keypoints must be be close to their shared stitching edge. We reject the pair of images if the homography of the matches violates our assumptions about the camera movement. For matches that conform to the camera constraints, we try to further filter out false matches by iteratively removing keypoints with the highest reprojection error, with the assumption that those keypoints correspond to moving or non-planar features. If these constraints cannot be satisfied, we proceed with the original RANSAC inliers.

The resulting keypoint and feature matches are then passed into the OpenCV stitching pipeline while also forcing the images to be stitched in their given order. We utilize the OpenCV bundle adjustment, seam finding (dynamic programming color gradient), and blending (multiband) to create the final mosaic. However, the OpenCV pipeline assumes a stationary (no translation) camera rotating about its axis rather than a moving camera. As such, the images are projected onto a sphere rather than a plane and the degrees of freedom optimized in the bundle adjustment are camera rotations and focal lengths. We are still determining the extent to which this assumption can be relaxed, but the pipeline works for translating cameras moving mostly in one direction for short distances (e.g. 20-30 images), while too many images leads to bundle adjustment failure or unreasonable run times because the optimization problem becomes too difficult. A partial affine transformation is also available when the spherical projection assumption performs worse than a partial affine stitch without bundle adjustment. Both camera modes will create mosaics that "drift" if the camera angle does not remain normal to the image plane, though this is partially corrected in the spherical projection using wave correction. Regardless of the camera mode used, plant movement or matching using very non-planar points can create "ghosting" even after seam finding, though the spherical camera mode performs better than the partial affine mode.

To accomodate mosaics that require many images (i.e. high camera translation), we stitch the mosaics in batches and then stitch the batches together. If a batch mosaic cannot be generated, the constraints are modified or the camera mode is changed to try to produce a successful batch mosaic. Since the mosaics may be quite large, stitching the batch mosaics together into the final mosaic can be difficult because error in rotations will cause large displacements. To improve the stitching of the final mosaic, we straighten and rescale each batch mosaic prior to stitching and assume that all panoramas can be stitched together using simple x and y translation. This straightening process may create distortion, as we warp the images assuming that the midline of each batch should be a straight line. Once the batch mosaics are straightened and aligned, we perform another seam finding and blending step to produce the final mosaic. If the camera height (i.e. image scale) or angle changes a lot across the batches, there may be additional ghosting at the batch seams and the final mosaic may "drift". Thus, we repeat the straightening process on the final panorama to create a mosaic with a rectangular shape.

